---
title: "Dataset cleaning"
author: "ПП1"
date: "2022-12-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (dplyr)
library (tibble)
library (stringr)
library (readr)
library (readxl)

library(data.table)
library(flextable)
library(mice)
library(ggmice)
library(ggplot2)
library(Rmisc)
```

# 0. Загрузка и чтение данных, подготовка возраста

```{r}
file_list <- list.files(pattern='\\d\\.xlsx')
data <- data.frame()
list <- list()
 for (i in 1:length(file_list)) {
  df <- read_excel(as.character(file_list[i]))
  df$`год` <- parse_number(file_list[i])        # создаём столбец с годом
  if (ncol(df) != ncol(data)) {                 # если количество колонок в датафреймах разное
    data <- plyr::rbind.fill(data, df) }
  else {
    colnames(df) <- colnames(data)              # если количество колонок одинаковое, а имена - разные
    data <- rbind(data, df) }
  }  

data <- subset(data, select = -c(`...24`))
```

```{r}
# если в столбце мёртвый/живой указан какой-либо из бинарных толкований этого признака, 
# в значении возраста оставляем 0, в ином случае возраст не меняем
data$`возраст` <- ifelse(data$`мёртвый/живой` %in% c('мертв', 'м','мёртвый', 'мертвый', 'М'), 0, data$возраст)
# если в значении возраст - пропуск, а в значении мертвый/живой - истинное значение возраста,  
# переносим это значение в возраст, в ином случае возраст не меняем
data$`возраст` <- ifelse(is.na(data$`возраст`) ==  T, data$`мёртвый/живой`, data$`возраст`)

# придадим бинарную форму столбцу мёртвый/живой
data$`мёртвый/живой` <- ifelse(data$`возраст` == 0, 'мертв', 'жив')
```

# 1. Проверка на "вшивость" (чанк для себя, для финального кода НЕ НУЖЕН)

```{r}
df <- data
df <- as_tibble(df) # Загрузка данных и преобразование в tibble

df <- df %>%
  mutate (across(c(`гестация`, `длина тела`, `масса тела`, `мозг`, `сердце`, `лёгкие`, `печень`,`мацерация`, `ВПР`), function(x) as.factor(x))) # Привести все переменные к факторным, чтобы следующим шагом отследить все уникальные значения и потенциальные "косяки"
 
lapply(df[ , sapply(df, is.factor)], function(v) {
  data.frame(Levels=levels(unique(sort(v))),
             Values=as.numeric(unique(sort(v)))) 
})# Посмотреть на все уровни факторных переменных и проверить "косяки"
```

 

 

# 2. Чистка и преобразование переменных - пол, гестация, длина тела, масса тела, мозг, сердце, лёгкие, печень, мацерация, ВПР - к нужному типу (ГЛАВНЫЙ ЧАНК)

```{r}
# Загрузка данных и преобразование в tibble:

df <- data
df <- as_tibble(df) 

#Замена запятых на точки в количественных переменных:

df <- df %>% 
  mutate (across(c(`гестация`, `длина тела`, `масса тела`, `мозг`, `сердце`, `лёгкие`, `печень`, `мацерация`,`ВПР`), function(x) as.character(x))) %>%
  mutate (across (c(`гестация`, `длина тела`, `масса тела`, `мозг`, `сердце`, `лёгкие`, `печень`), function(y) gsub(",", ".", y)))

# Работа с категориальными переменными:

df <- df %>%
  mutate(`пол` = recode(`пол`, 'f'='ж', 'm'='м'))
df$пол <- replace(df$пол, df$пол %in% c("?","м и ж","НЕТ ПЕРВОГО ЛИСТА", "НЕТ ПРОТОКОЛА", "нет возможности определить", "не указано", "н/п"), NA)


df <- df %>%
  mutate(`мацерация` = recode(`мацерация`, 'мумификация'='да'))
df$ВПР <- replace(df$ВПР,df$ВПР == "?",NA)


#Предобработка явных косяков в количественных переменных:

df <- df %>%
  mutate(`масса тела` = recode(`масса тела`, '39-70' = '3970', '10.4' = '1040', '17.5' = '1750', '31.8' = '3180'))%>%
  mutate(`мозг` = recode(`мозг`, '660+112' = '772', '50+60' = '110')) 


# Окончательная чистка и приведение к нужному типу:

df$гестация <- parse_number(df$гестация, na = c("?", "???", "?7", "@", "5 лет")) #Гестация


df$`длина тела` <- parse_number(df$`длина тела`, na = c("?", "?1","?2","?3","?5","?6", "?7","?9","@","5 лет","0")) #Длина тела


df$`масса тела` <- str_replace_all(df$`масса тела`, regex("\\s*"), "")
df$`масса тела` <- parse_number(df$`масса тела`, na = c("?","??20","?30","@","3 мес","5 лет","9 лет")) #Масса тела


df$мозг <- str_replace_all(df$мозг, regex("\\s*"), "")
df$мозг <- parse_number(df$мозг, na = c("-","!","!!!","?","???", "@", "0")) #Мозг


df$сердце <- parse_number(df$сердце, na = c("?", "@"))
df$сердце <-replace(df$сердце,df$сердце > 44000,NA) #Сердце


df$лёгкие <- sapply(regmatches(df$лёгкие, gregexpr("[[:digit:]]+\\.*[[:digit:]]*", df$лёгкие)), function(x) sum(as.numeric(x)))
df$лёгкие <-replace(df$лёгкие,df$лёгкие > 44000,NA)
df$лёгкие <-replace(df$лёгкие,df$лёгкие == 0,NA) #Лёгкие


df$печень <- str_replace_all(df$печень, regex("\\s*"), "")  
df$печень <- parse_number(df$печень, na = c("?", "@", "0"))
df$печень <-replace(df$печень,df$печень > 44000,NA) #Печень


df <- df %>%
  mutate(across(c(`пол`, `мёртвый/живой`, `мацерация`,`ВПР`), function(x) as.factor(x)))%>%
  mutate(across(c(`длина тела`, `масса тела`, `мозг`, `сердце`, `лёгкие`, `печень`), function(x) round(x,2))) # Окончательный вид
```

# 3. Часть кода для очистки переменных - селезёнка, почки, тимус, н/п, пжж, плацента - к нужному типу (ГЛАВНЫЙ ЧАНК)

```{r}

df <- df %>%
  mutate (across(c(`селезёнка`,`почки`,`тимус`,`н/п`,`пжж`,`плацента`), function(x) as.factor(x))) 
 
```

```{r}
lapply(df[ , sapply(df, is.factor)], function(v) {
  data.frame(Levels=levels(unique(sort(v))),
             Values=as.numeric(unique(sort(v)))) })

```

```{r}
df <- df %>% 
  mutate (across(c(`селезёнка`,`почки`,`тимус`,`н/п`,`пжж`,`плацента`), function(x) as.character(x))) %>%
  mutate (across (c(`селезёнка`,`почки`,`тимус`,`н/п`,`пжж`,`плацента`), function(y) gsub(",", ".", y)))

df <- df %>%
  mutate(`почки` = recode(`почки`, '11,64 гр' = '11.64', '12,07 гр' = '12.07','120 (обе)' = '120'))%>%
  mutate(`тимус` = recode(`тимус`, '0.9-1' = '0.9'))%>%
  mutate(`плацента` = recode(`плацента`, '150 г' = '150', '310 г' = '310','380 г' = '380'))

```

```{r}

df$селезёнка <- parse_number(df$селезёнка, na = c("@","5,1 и 6,8", "abs", "N", "аут", "аутолиз", "Аутолиз", "ен", "и","л","ли","нет","ный","о","п-8,1 л-5","т","то","тол","фра"))
df$селезёнка <-replace(df$селезёнка,df$селезёнка > 40000,NA)


df$почки <- sapply(regmatches(df$почки, gregexpr("[[:digit:]]+\\.*[[:digit:]]*", df$почки)), function(x) sum(as.numeric(x)))
df$почки <-replace(df$почки,df$почки == 0,NA)
df$почки <-replace(df$почки,df$почки > 40000,NA)

df$тимус <- parse_number(df$тимус, na = c("?", "0","@","16,?","41,9/9","7.0000000000000007E-2","abs","аут","аутолиз", "Аутолиз","з","и","л","не доставлено","ра","тац","у","ц"))
df$тимус <-replace(df$тимус,df$тимус > 40000,NA)

df$`н/п` <- sapply(regmatches(df$`н/п`, gregexpr ("[[:digit:]]+\\.*[[:digit:]]*", df$`н/п`)), function(x) sum(as.numeric(x)))
df$`н/п` <- replace(df$`н/п`, df$`н/п` == 0,NA)
df$`н/п` <- replace(df$`н/п`, df$`н/п` > 40000,NA)


df$пжж <- parse_number(df$пжж, na = c("?", "0,?","@","аутолиз", "Аутолиз","з","из","нет","олиз","толиз","я"))
df$пжж <-replace(df$пжж,df$пжж > 40000,NA)

df$плацента <- parse_number(df$плацента, na = c("?", "@","0.00", "1 250,0","120 и 130","120;220","138;130","138;196","140 и 230","160 и 372","1пл1672пл169","1пл208.2пл170","200и1200","210;280","226; 177","235;350","240 и 280","250\\115","260 и 175","325\\300","330\\244","350;150","400и350","440 и 270","70 и 355","Асфиксия новорожденного. Порст гипоксический отек - набухание головного мозга. Множественные ателектазы в легких. Дистрофия миокарда. печени. почек. Понкровие внутренних органов. Недоношенность.","б/о","без патологий","не доставлена","не прислана","нет"))

```

```{r}

df <- df %>%
  mutate(across(c(`селезёнка`,`почки`,`тимус`,`н/п`,`пжж`,`плацента`), function(x) round(x,2)))

```

# 4. Часть кода для очистки переменных - возраст, многоплодная, СЗРП, окружность головы, окружность груди к нужному типу (ГЛАВНЫЙ ЧАНК)

```{r}
library (tidyr)

#Создадим переменную, состоящую из номера протокола и года
df <- df %>%
  mutate(`id_year` = paste(`№ протокола`, "_", год))



#В таблице приведены уникальные id субъектов (номер протокола + год) и исправленный возраст (добавлены пробелы между цифрами и ед. измерения)
table_change <- read_excel("data.xlsx", sheet = "wrong")


#Объединяем исходный набор данных с новой исправленной переменной
df <- left_join(df, table_change, by="id_year")

#Перезаписываем корректные значений
df <- df %>%
  mutate(`age_fin` = if_else(!is.na(new),`new`, `возраст`))


#Разделим возраст на 8 столбцов
df <- df %>%
  mutate(age_copy = age_fin) %>%
  separate(age_fin, into  = c("Var1","Var1_ed" ,"Var2","Var2_ed", "Var3","Var3_ed", "Var4","Var4_ed"), sep = " ") %>%
  mutate(`Var1` = as.numeric(`Var1`), `Var2` = as.numeric(`Var2`), `Var3` = as.numeric(`Var3`), `Var4` = as.numeric(`Var4`))


#Создадим сводные таблицы по единицам измерений возраста, чтобы далее привести их к единому формату
var1_tabf <- as.data.frame(table(df$Var1_ed))
var2_tabf <- as.data.frame(table(df$Var2_ed))
var3_tabf <- as.data.frame(table(df$Var3_ed))
var4_tabf <- as.data.frame(table(df$Var4_ed))



#На основе сводных таблиц перекодируем единицы измерения
df <- df %>%
  mutate(`Var1_ed_fin` = ifelse(Var1_ed %in% c("гибель", "ПРОТОКОЛА", "сердцебиен", "сердцебиение", "сердцебиением", "указан"), NA, 
                            ifelse(Var1_ed %in% c("г", "год", "года"), "год", 
                                ifelse(Var1_ed %in% c("д",	"д.",	"дней",	"дней,",	"дня",	"жд"), "день", 
                                   ifelse(Var1_ed %in% c("л",	"лет"), "лет",
                                      ifelse(Var1_ed %in% c("м",	"мес",	"мес.",	"месяц",	"месяца",	"месяцев"), "месяц",
                                          ifelse(Var1_ed %in% c("мин",	"минут"), "минута",
                                             ifelse(Var1_ed %in% c("нед"), "неделя",
                                                ifelse(Var1_ed %in% c("сек"), "секунда",
                                                    ifelse(Var1_ed %in% c("с.",	"сут.",	"сутки",	"суток",	"сутоок"), "сутки",  
                                                        ifelse(Var1_ed %in% c("ч",	"ч.",	"час",	"час.",	"часа",	"часов"), "час", "none")))))))))) %>% as.factor()) %>% 
  
  mutate(`Var2_ed_fin` = ifelse(Var2_ed %in% c("д",	"д.",	"дн",	"дней",	"дня", "день"), "день", 
                                ifelse(Var2_ed %in% c("мес",	"месяца",	"месяцев"), "месяц",
                                       ifelse(Var2_ed %in% c("мин","мин.","минут", "минуты", "м.", "м", "минута"), "минута",
                                              ifelse(Var2_ed %in% c("сек"), "секунда",
                                                     ifelse(Var2_ed %in% c("сут","суток"), "сутки",
                                                            ifelse(Var2_ed %in% c("ч",	"ч.",	"час",	"час.",	"часа",	"часаов",	"часов",	"часов.",	"ччасов"), "час", "none")))))) %>% as.factor()) %>%
  
  mutate(`Var3_ed_fin` = ifelse(Var3_ed %in% c("д"), "день", 
                                ifelse(Var3_ed %in% c("м",	"м.",	"мин",	"мин.",	"минут",	"минут.",	"минута",	"минуту",	"минуты"), "минута",
                                       ifelse(Var3_ed %in% c("ч",	"ч."), "час", "none")))  %>% as.factor()) %>%
  mutate(`Var4_ed_fin` = ifelse(Var4_ed %in% c("мин"), "минута", "none")  %>% as.factor()) 



#Для каждой единицы измерения создадим множитель для перевода в дни
df <- df %>%
  mutate(`Time1` = ifelse(Var1_ed_fin %in% "none", 1,
                          ifelse(Var1_ed_fin %in% c("год",	"лет"), 365,
                                 ifelse(Var1_ed_fin %in% "месяц", 30,
                                        ifelse(Var1_ed_fin %in% "неделя", 7,
                                               ifelse(Var1_ed_fin %in% c("день",	"сутки"), 1, 
                                                      ifelse(Var1_ed_fin %in% "час", 1/24,
                                                             ifelse(Var1_ed_fin %in% "минута", 1/1440, 
                                                                    ifelse(Var1_ed_fin %in% "секунда", 1/86400,NA)))))))))%>% 
  
  mutate(`Time2` = ifelse(Var2_ed_fin %in% "none", 0,
                          ifelse(Var2_ed_fin %in% "месяц", 30,
                                 ifelse(Var2_ed_fin %in% c("день",	"сутки"), 1, 
                                        ifelse(Var2_ed_fin %in% "час", 1/24,
                                               ifelse(Var2_ed_fin %in% "минута", 1/1440, 
                                                      ifelse(Var2_ed_fin %in% "секунда", 1/86400,NA))))))) %>% 
  
  mutate(`Time3` = ifelse(Var3_ed_fin %in% "none", 0,
                          ifelse(Var3_ed_fin %in% c("день",	"сутки"), 1, 
                                 ifelse(Var3_ed_fin %in% "час", 1/24,
                                        ifelse(Var3_ed_fin %in% "минута", 1/1440,NA))))) %>%
  
  mutate(`Time4` = ifelse(Var4_ed_fin %in% "none", 0,
                          ifelse(Var4_ed_fin %in% "минута", 1/1440,NA))) %>%
  mutate(Time1_days = Var1 * Time1) %>% 
  mutate(Time2_days = Var2 * Time2) %>%
  mutate(Time3_days = Var3 * Time3) %>%
  mutate(Time4_days = Var4 * Time4) %>%
  rowwise()
```

```{r}
df <- df %>%
  mutate(Age = rowSums(df[,44:47], na.rm = TRUE))
```

```{r}
#Версия датасета с обработанным возрастом (округление до целых в большую сторону - Age), переменными многоплодная - окружность груди
df <- df %>%
  mutate(`Age` = ceiling(`Age`)) %>%
  mutate(across(c(`многоплодная`,`СЗРП`), function(x) as.factor(x))) %>%
  mutate(across(c(`окружность головы`, `окружность груди`),  function(x) gsub(",", ".", x))) %>%
  mutate(across(c(`окружность головы`, `окружность груди`), function(y) as.numeric(y))) %>%
  select(`№ протокола`, `пол`, `мёртвый/живой`, `гестация`, `длина тела`, `масса тела`, `мозг`, `сердце`, `лёгкие`, 
         `печень`, `селезёнка`, `почки`, `тимус`, `н/п`, `пжж`, `плацента`, `мацерация`, `ВПР`, `многоплодная`, 
         `СЗРП`, `окружность головы`, `окружность груди`, `год`, `Age`)

```

# Фильтрация и создание нового датасета референсных значений df1, переименование

```{r}
df1 <- df %>%
  filter(!is.na(`№ протокола`) & 
         !is.na(пол) &
         Age <= 1 &
         гестация >= 14 &
         мацерация %in% c('нет', NA) &
         !grepl(paste(c("ЦНС","КМС","ВПР","ДС","МПС","Даун","Арнольда-Киари","ГС","гс", "ОГС","ЖКТ", "бетическая фетопатия", "Эдвардс", "по медпоказаниям","ССС", "лимфангиоэктазия","да"),collapse = '|'), ВПР) &
         многоплодная %in% c('нет', NA) &
         !grepl('СЗРП|ЗВУР', СЗРП)) %>%
  mutate(`мёртвый/живой` = ifelse(`мёртвый/живой` == "жив", "Живой", "Мёртвый")) %>%
  rename_with(function(x) x %>% str_to_sentence()) %>%
  dplyr::rename(`Надпочечники` = `Н/п`, `Поджелудочная железа` = `Пжж`, `Возраст в днях` = `Age`, `СЗРП` = `Сзрп`, `ВПР` = `Впр`)
  
# дофильтруем датасет по переменной ВПР
df1 <- df1 %>% filter(is.na(ВПР) |
  grepl(paste(c("инфекция", "аспирация", "пневмония", 'нет'), collapse = '|'), ignore.case = TRUE, ВПР))

df1$ВПР <- replace(df1$ВПР, df1$ВПР %in% c("инфекция неиммуная водянка", "гипоплазия лёгких инфекция"), "инфекция")

summary(df1)
```

write_csv(x = df1, file = "df1_csv.csv") - \# сохранение дата-фрейма.

# Описательная статистика для работы с пропусками

```{r}
statistics <- list(
      `Количество субъектов` = ~length(.x),
      `Количество (есть данные)` = ~sum(!is.na(.x)),
      `Нет данных` = ~sum(is.na(.x)),
      `Ср. знач.` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", mean(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `Станд. отклон.` = ~ifelse(sum(!is.na(.x)) < 3, "Н/П*", sd(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `мин. - макс.` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", paste0(min(.x, na.rm = TRUE) %>% round(2), " - ", max(.x, na.rm = TRUE) %>% round(2))),
      `Медиана` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", median(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", paste0(quantile(.x, 0.25, na.rm = TRUE) %>% round(2), " - ", quantile(.x, 0.75, na.rm = TRUE) %>% round(2)))
)



df1_all <- df1 %>%
  mutate(`Мёртвый/живой` = "Всего")

df1_work <- rbind(df1, df1_all)

stat_num_res <- df1_work %>%
  select(`Мёртвый/живой`, where(is.numeric)) %>%
  group_by(`Мёртвый/живой`) %>%
  dplyr::summarise(across(where(is.numeric), statistics)) %>%
  dplyr::mutate(across(everything(), as.character)) %>% 
  pivot_longer(!`Мёртвый/живой`) %>%
  separate(name, into  = c("Переменная","Статистика"), sep = "_") %>% 
  dcast(`Переменная` + `Статистика` ~ `Мёртвый/живой`, value.var = "value") 


stat_num_res %>% 
  flextable() %>%
  theme_box() %>%
  merge_v(c( "Переменная")) %>%
  set_caption("Описательная статистика количественных переменных") %>%
  width(width = 1.2)
```

# Заполнение пропусков методом MICE

## MICE - Multiple Imputation by Chained Equations (Множественная импутация в многоуровневой регрессии)

### Подготовка

Ознакомимся с ситуацией с пропусками по всему датасету в целом.

Посмотрим на количество пропущенных значений в каждом столбце, выделяя экстремально высокие (\>80%) и экстремально низкие (\<5%)

```{r}
table <- colSums(is.na(df1)) %>% 
  as.data.frame() %>% 
  mutate(`Процент` = `.`*100/nrow(df1)) %>% round(2) %>% 
  rownames_to_column("Признак") %>% setNames(., c('Признак', 'Кол-во пропусков', 'Процент')) %>%
  flextable()%>%
  theme_box() %>%
  set_table_properties(layout = "autofit") %>%
  color(i = ~ `Процент` <= 5, color = 'forestgreen') %>%
  color(i = ~ `Процент` > 80, color = 'red') 

table
```

Среди признаков есть как и с очень небольшим количеством пропусков, так и признаки с огромным количеством пропущенных значений.

**Об особенностях пропусков в столбцах Многоплодная, СЗРП, Мацерация:** кроме пропуска, столбцы Многоплодная и Мацерация сродержат лишь одно значение. Пропуски в этом случае замостим этим значением. Столбец СЗРП по итогам фильтрации не содержит ни одного значения. Все три столбца для дальнейшего анализа малоинформативны, и могут быть исключены из него.

```{r}
df1$Мацерация = "нет"
df1$Многоплодная = "нет"
df1$СЗРП = NULL
```

### Выполнение

```{r}
# подготовка к MICE

# запомним датасет с пропусками в переменной data_NA (нужно для дальнейшего сравнения)
df1_NA <- df1

# сохраняем номера и названия столбцов во вспомогательной таблице:
names_coded <- as.data.frame(1:ncol(df1)) %>% setNames(., 'key')
names_coded[,1] <- lapply(names_coded, function(x) paste("col", x, sep="_"))
names_coded$column <- colnames(df1)

# переименуем колонки датасета
df1 <- setNames(df1, names_coded$key) 

# инициируем импутацию
init = mice(df1, maxit=0) 
method = init$method
pred_matrix = init$predictorMatrix

# выключаем неинформативные переменные из предикторов. К предикторам не должны относиться: 
# № протокола, 'Год', "Мацерация" и "Многоплодная" 
no_predictors <- grep(paste(c('№ протокола', 'Год', 'Многоплодная','Мацерация'), collapse = '|'), names_coded$column)
pred_matrix[, c(names_coded$key[no_predictors])] = 0

#начинаем импутацию ~ 15 сек
set.seed(42)
imputed = mice(df1, 
               method = method, 
               predictorMatrix = pred_matrix, 
               m = 5)

# сохраняем готовый датасет, возвращаем имена колонкам
df1 <- complete(imputed)
df1 <- setNames(df1, names_coded$column)

# проверяем результат
table <- colSums(is.na(df1)) %>% 
  as.data.frame() %>% 
  rownames_to_column("Признак") %>% setNames(., c('Признак', 'Кол-во пропусков')) %>%
  flextable()%>%
  theme_box() %>%
  set_table_properties(layout = "autofit")

table 
```

### Анализ результатов

Проверка качества импутации будет оценена визуально путем сравнения графиков плотности распределения наблюдаемых значений и импутированных значений, а также путём составления сводной таблицы с основными статистиками

Анализировать результаты будем раздельно по категориальным и количественным признакам

#### Количественые признаки

Сводная таблица (только для столбцов, в которых была произведена импутация)

```{r}
# основные статистики
statistics <- list(
      `_Количество субъектов` = ~length(.x) %>% as.character(),
      `_Количество (есть данные)` = ~ sum(!is.na(.x)) %>% as.character(),
      `_Нет данных` = ~ sum(is.na(.x)) %>% as.character(),
      `_Ср. знач.` = ~ mean(.x, na.rm = TRUE) %>% round(2) %>% as.character(),
      `_Станд. отклон.` = ~ sd(.x, na.rm = TRUE) %>% round(2) %>% as.character(),
      `_95% ДИ для среднего` = ~ paste0(CI(na.omit(.x), ci = 0.95)[3] %>% round(2), '-', CI(na.omit(.x), ci = 0.95)[1] %>% round(2)) %>% as.character(),
      `_мин. - макс.` = ~ paste0(min(.x, na.rm = TRUE) %>% round(2), " - ", max(.x, na.rm = TRUE) %>% round(2)) %>% as.character(),
      `_Медиана` = ~ median(.x, na.rm = TRUE) %>% round(2) %>% as.character(),
      `_Q1 - Q3` = ~ paste0(quantile(.x, 0.25, na.rm = TRUE) %>% round(2), " - ", quantile(.x, 0.75, na.rm = TRUE) %>% round(2) %>% as.character())
      )
```

```{r}
df1_NA_work <- df1_NA %>% 
  select(ВПР, where(is.numeric)) %>% as.data.frame()

df1_work <- df1 %>% 
  select(ВПР, where(is.numeric)) %>% as.data.frame()

df1_NA_work$признаки <- "До заполнения"
df1_work$признаки <- "После заполнения"
df_comp <- rbind(df1_NA_work, df1_work)

# собираем тольео импутированные столбцы
stat_num_res <- df_comp %>% 
  subset(select = -c(`Гестация`, `Возраст в днях`, `Год`, `ВПР`)) %>%
  select(`признаки`, where(is.numeric)) %>% 
  group_by(`признаки`) %>%
  dplyr::summarise(across(where(is.numeric), statistics)) %>%
  t() %>% as.data.frame() %>% rownames_to_column("value") %>%
  `colnames<-`(.[1, ]) %>% .[-1, ] %>%
  separate(`признаки`, into = c("Переменная","Статистика"), sep = '_') %>% 
  flextable() %>%
  theme_box() %>%  
  merge_v('Переменная') %>%
  set_table_properties(layout = "autofit") %>%
  flextable::align(j = c(1, 3:4), align = "center", part = 'all') 

stat_num_res
```

Графики плотности распределения для каждой из переменных

```{r}
ggmice(imputed, aes(x = col_5, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Длина тела"') + 
  labs(x = 'Длина тела', y = 'Плотность')

ggmice(imputed, aes(x = col_6, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Масса тела"') + 
  labs(x = 'Масса тела', y = 'Плотность')

ggmice(imputed, aes(x = col_7, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Мозг"') + 
  labs(x = 'Мозг', y = 'Плотность')

ggmice(imputed, aes(x = col_8, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Сердце"') + 
  labs(x = 'Сердце', y = 'Плотность')

ggmice(imputed, aes(x = col_9, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Лёгкие"') + 
  labs(x = 'Лёгкие', y = 'Плотность')

ggmice(imputed, aes(x = col_10, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Печень"') + 
  labs(x = 'Печень', y = 'Плотность')

ggmice(imputed, aes(x = col_11, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Селезёнка"') + 
  labs(x = 'Селезёнка', y = 'Плотность')

ggmice(imputed, aes(x = col_12, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Почки"') + 
  labs(x = 'Почки', y = 'Плотность')

ggmice(imputed, aes(x = col_13, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Тимус"') + 
  labs(x = 'Тимус', y = 'Плотность')

ggmice(imputed, aes(x = col_14, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Надпочечники"') + 
  labs(x = 'Надпочечники', y = 'Плотность')

ggmice(imputed, aes(x = col_15, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Поджелудочная железа"') + 
  labs(x = 'Поджелудочная железа', y = 'Плотность')

ggmice(imputed, aes(x = col_16, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Плацента"') + 
  labs(x = 'Плацента', y = 'Плотность')

ggmice(imputed, aes(x = col_20, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Окружность головы"') + 
  labs(x = 'Окружность головы', y = 'Плотность')

ggmice(imputed, aes(x = col_21, group = .imp)) +
  geom_density() +
  ggtitle('График плотности распределения различных этапов импутации \n для переменной "Окружность груди"') + 
  labs(x = 'Окружность груди', y = 'Плотность')

```

#### Категориальные признаки

Сводная таблица

```{r}
stat_cat_res <- df_comp %>%
  select(`признаки`, `ВПР`) %>% 
  group_by(`признаки`) %>%
  count(`признаки` ~ `ВПР`) %>%
  mutate(`% по выборке` = round(freq*100/(nrow(df_comp)/2), 2)) %>%
  tidyr::pivot_wider(names_from = c(`признаки`),
                     values_from = c(`freq`, `% по выборке`)) %>%
  setNames(c('ВПР', 'Кол-во до заполнения', 'Кол-во после заполнения',
           '% по выборке до заполнения', '% по выборке после заполнения')) %>%
  flextable() %>%
  theme_box() %>%
  set_table_properties(layout = "autofit") %>%
  flextable::align(j = c(2:5), align = "center", part = 'all') 

stat_cat_res <- compose(stat_cat_res, i = 5, j = 1, as_paragraph(as_chunk('пропущено')))
stat_cat_res <- compose(stat_cat_res, i = 5, j = 3, as_paragraph(as_chunk('-')))
stat_cat_res <- compose(stat_cat_res, i = 5, j = 5, as_paragraph(as_chunk('-')))

stat_cat_res
```

```{r}
barplot(prop.table(table(as.factor(as.character(df1_NA_work$ВПР)))),
        col = c("#eb8060", "#b9e38d", "#a1e9f0", "#d9b1f0"),
        main = "Распределение различных значений столбца ВПР до импутации")

barplot(prop.table(table(as.factor(as.character(df1_work$ВПР)))),
        col = c("#eb8060", "#b9e38d", "#a1e9f0", "#d9b1f0"),
        main = "Распределение различных значений столбца ВПР после импутации")
```
